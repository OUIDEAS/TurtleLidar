<!--
=========================================================
 Light Bootstrap Dashboard - v2.0.1
=========================================================

 Product Page: https://www.creative-tim.com/product/light-bootstrap-dashboard
 Copyright 2019 Creative Tim (https://www.creative-tim.com)
 Licensed under MIT (https://github.com/creativetimofficial/light-bootstrap-dashboard/blob/master/LICENSE)

 Coded by Creative Tim

=========================================================

 The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  -->
<!DOCTYPE html>
<html lang="en">
<script>
function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp * 1000);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var year = a.getFullYear();
  var month = months[a.getMonth()];
  var date = a.getDate();
  var hour = a.getHours();
  var min = a.getMinutes();
  var sec = a.getSeconds();
  var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
  return time;
}
</script>
<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename="img/apple-icon.png")}}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename="img/favicon.ico")}}">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Turtle Rover Data</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latestcss/font-awesome.min.css" />
    <!-- CSS Files -->
    <link href="{{ url_for('static', filename="css/bootstrap.min.css")}}" rel="stylesheet" />
    <link href="{{ url_for('static', filename="css/light-bootstrap-dashboard.css")}}" rel="stylesheet" />
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link href="{{ url_for('static', filename="css/demo.css")}}" rel="stylesheet" />
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-color="green" data-image="{{ url_for('static', filename="img/sidebar-5.jpg")}}">
            <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

        Tip 2: you can also add an image using data-image tag
    -->
            <div class="sidebar-wrapper">
                <div class="logo">
                    <a href="./" class="simple-text">
                        Rover Control
                    </a>
                </div>
                <ul class="nav">
                    <!-- <li class="nav-item active">
                        <a class="nav-link" href="dashboard.html">
                            <i class="nc-icon nc-chart-pie-35"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./user.html">
                            <i class="nc-icon nc-circle-09"></i>
                            <p>User Profile</p>
                        </a>
                    </li> -->
                    <li>
                        <a class="nav-link" href="./">
                            <i class="nc-icon nc-chart-pie-35"></i>
                            <p>Control</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./sensor-data">
                            <i class="nc-icon nc-chart-pie-36"></i>
                            <p>Sensor Data</p>
                        </a>
                    </li>
                    <!-- <li>
                        <a class="nav-link" href="./typography.html">
                            <i class="nc-icon nc-paper-2"></i>
                            <p>Typography</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./icons.html">
                            <i class="nc-icon nc-atom"></i>
                            <p>Icons</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./maps.html">
                            <i class="nc-icon nc-pin-3"></i>
                            <p>Maps</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./notifications.html">
                            <i class="nc-icon nc-bell-55"></i>
                            <p>Notifications</p>
                        </a>
                    </li>
                    <li class="nav-item active active-pro">
                        <a class="nav-link active" href="upgrade.html">
                            <i class="nc-icon nc-alien-33"></i>
                            <p>Upgrade to PRO</p>
                        </a>
                    </li> -->
                </ul>
            </div>
        </div>
        <div class="main-panel">
            <!-- Navbar -->
            <!-- <nav class="navbar navbar-expand-lg " color-on-scroll="500">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#pablo"> Table List </a>
                    <button href="" class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-bar burger-lines"></span>
                        <span class="navbar-toggler-bar burger-lines"></span>
                        <span class="navbar-toggler-bar burger-lines"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-end" id="navigation">
                        <ul class="nav navbar-nav mr-auto">
                            <li class="nav-item">
                                <a href="#" class="nav-link" data-toggle="dropdown">
                                    <i class="nc-icon nc-palette"></i>
                                    <span class="d-lg-none">Dashboard</span>
                                </a>
                            </li>
                            <li class="dropdown nav-item">
                                <a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
                                    <i class="nc-icon nc-planet"></i>
                                    <span class="notification">5</span>
                                    <span class="d-lg-none">Notification</span>
                                </a>
                                <ul class="dropdown-menu">
                                    <a class="dropdown-item" href="#">Notification 1</a>
                                    <a class="dropdown-item" href="#">Notification 2</a>
                                    <a class="dropdown-item" href="#">Notification 3</a>
                                    <a class="dropdown-item" href="#">Notification 4</a>
                                    <a class="dropdown-item" href="#">Another notification</a>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="nc-icon nc-zoom-split"></i>
                                    <span class="d-lg-block">&nbsp;Search</span>
                                </a>
                            </li>
                        </ul>
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="#pablo">
                                    <span class="no-icon">Account</span>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="no-icon">Dropdown</span>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <a class="dropdown-item" href="#">Something</a>
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="divider"></div>
                                    <a class="dropdown-item" href="#">Separated link</a>
                                </div>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#pablo">
                                    <span class="no-icon">Log out</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav> -->
            <!-- End Navbar -->
            <div class="content">
                <div class="card card-plain table-plain-bg">
                    <div class="card-header ">
                        <h4 class="card-title">Turtle Lidar Data</h4>
                        <p class="card-category">
                            <!--<a href="./database" download="RobotLidarData.zip">Download CSV Zip File</a>-->
                            <button type="button" onclick="DownloadData();">Download Data</button>
                            <button type="button" onclick="RequestClearData();">Clear Data</button>
                            <button type="button" onclick="RequestResetData();">Reset Data</button>
                        </p>
                    </div>
                    <div class="card-body table-full-width table-responsive">
                        <table id="datatable" class="table table-hover">
                            <thead>
                                <th>Download</th>
                                <th>ID</th>
                                <th>Timestamp</th>
                                <th>Odometer</th>
                                <th>Average R</th>
                                <th>STD R</th>
                                <th>Minimum R</th>
                                <th>Maximum R</th>
                                <th>Center X</th>
                                <th>Center Y</th>
                                <th>Battery Voltage</th>
                                <th>Camera</th>
                                <th>Data Plot</th>
                            </thead>
                            <tbody>
                                {% for row in displayEntries %}
                                    <tr id="row{{ row[0] }}">
                                        {% for item in row %}
                                            {% if loop.index == 1 %}
                                                <td><input type="checkbox" id="checkbox{{ row[0] }}" name="checkbox_dataselect" checked="true"></td>
                                                <td>{{item}}</td>
                                            {% elif loop.index == 2 %}
                                                <td><script>document.write(timeConverter({{item}}));</script></td>
                                            {% elif loop.index > 2 %}
                                                <td> {{"%.3f"%item}} </td>  
                                            {% endif %}
                                        {% endfor %}
                                        <td><button id="button_cam{{ row[0] }}" onclick="showimage({{ row[0] }}, 'cam')">Show Camera</button>
                                            <!--<a href ="/camerapic/{{ row[0] }}">Camera</a></td>-->
                                        <td><button id="button_data{{ row[0] }}" onclick="showimage({{ row[0] }}, 'data')">Show Data</button>
                                        <!--<td><a href ="/polarplot/{{ row[0] }}">Data Plot</a></td>-->
                                    </tr>
                                    <tr style="display:none;" id="datarow{{ row[0] }}"><td id="tdcam{{ row[0] }}"></td><td id="tddata{{ row[0] }}"></td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <div class="container-fluid">
                    <nav>
                        <ul class="footer-menu">
                            <li>
                                <a href="/">
                                    Home
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/OUIDEAS/TurtleLidar">
                                    Project Repository
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                </a>
                            </li>
                        </ul>
                        <p class="copyright text-center">
                            ©
                            <script>
                                document.write(new Date().getFullYear())
                            </script>
                            <a href="https://ouideas.github.io/">IDEAS Lab</a>
                        </p>
                    </nav>
                </div>
            </footer>
        </div>
    </div>
</body>
<!--   Core JS Files   -->
<script src="{{ url_for('static', filename="js/core/jquery.3.2.1.min.js")}}" type="text/javascript"></script>
<script src="{{ url_for('static', filename="js/core/popper.min.js")}}" type="text/javascript"></script>
<script src="{{ url_for('static', filename="js/core/bootstrap.min.js")}}" type="text/javascript"></script>
<!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
<script src="{{ url_for('static', filename="js/plugins/bootstrap-switch.js")}}"></script>
<!--  Chartist Plugin  -->
<script src="{{ url_for('static', filename="js/plugins/chartist.min.js")}}"></script>
<!--  Notifications Plugin    -->
<script src="{{ url_for('static', filename="js/plugins/bootstrap-notify.js")}}"></script>
<!-- Control Center for Light Bootstrap Dashboard: scripts for the example pages etc -->
<script src="{{ url_for('static', filename="js/light-bootstrap-dashboard.js")}}" type="text/javascript"></script>
<!-- Light Bootstrap Dashboard DEMO methods, don't include it in your project! -->
<script src="{{ url_for('static', filename="js/demo.js")}}"></script>
<script>
function showimage(dataid, camordata) {
    var table = document.getElementById("datatable");



    /*if(!foundtd)
    {
    var b4row = document.getElementById("row"+rowid).rowIndex;
    var row = table.insertRow(b4row+1);
    row.id = "pic_row"+dataid;
    }
    else
    row = foundtd;*/

    var row = document.getElementById("datarow"+dataid);
    row.style = "display; table-row";

    if(camordata.localeCompare('cam') == 0) {
        //var cell1 = row.insertCell(0);
        var cell1 = document.getElementById("tdcam"+dataid);
        //cell1.id = "dataimage" + dataid;
        cell1.innerHTML = "<a href =\"/camerapic/" + dataid + "\" target=\"_blank\"><img width=200 src=\"/camerapic/" + dataid + "\"></a>";

        //NEW CELL1 " + dataid + " " + rowid;
        var but = document.getElementById("button_cam" + dataid);

        but.innerHTML = "Hide Camera";
        but.setAttribute("onClick", "hideimage(" + dataid + ", 'cam')");
    }
    else {
        var cell1 = document.getElementById("tddata"+dataid);
        //cell1.id = "dataimage" + dataid;
        cell1.innerHTML = "<a href =\"/polarplot/" + dataid + "\" target=\"_blank\"><img width=200 src=\"/polarplot/" + dataid + "\"></a>";
        var but = document.getElementById("button_data" + dataid);
        but.innerHTML = "Hide Data";
        but.setAttribute("onClick", "hideimage(" + dataid + ", 'data')");
    }
}
function hideimage(dataid, camordata) {
    var cellcam = document.getElementById("tdcam"+dataid);
    var celldata = document.getElementById("tddata"+dataid);
    if(camordata.localeCompare('cam') == 0) {

        //cell1.id = "dataimage" + dataid;
        cellcam.innerHTML = "";
        var but = document.getElementById("button_cam"+dataid);
        but.innerHTML="Show Camera";
        but.setAttribute( "onClick","showimage("+dataid+", 'cam')");
    }
    else{

        //cell1.id = "dataimage" + dataid;
        celldata.innerHTML = "";
        var but = document.getElementById("button_data"+dataid);
        but.innerHTML="Show Data";
        but.setAttribute( "onClick","showimage("+dataid+", 'data')");
    }
    var t1 = cellcam.innerHTML.localeCompare("");
    var t2 = celldata.innerHTML.localeCompare("");
    if(t1==0 && t2==0)
    {
        var row = document.getElementById("datarow"+dataid);
        row.style = "display: none;";
    }

}
function GetChecks()
{
    var checkboxes = document.getElementsByName("checkbox_dataselect");
    var checkboxesChecked = [];
    // loop over them all
    for (var i=0; i<checkboxes.length; i++) {
        // And stick the checked ones onto an array...
        if (checkboxes[i].checked) {
            var newitem = checkboxes[i].id.replace("checkbox","");
            newitem = parseInt(newitem);
            checkboxesChecked.push(newitem);
        }
    }
    // Return the array if it is non-empty, or null
    return checkboxesChecked.length > 0 ? checkboxesChecked : null;
}
function ClearAllChecks()
{
    var checkboxes = document.getElementsByName("checkbox_dataselect");
    // loop over them all
    for (var i=0; i<checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
}
function DownloadData()
{
    var req_items = GetChecks();
    req_items = JSON.stringify({selitems:req_items});
    $.ajax({
            type: "POST",
            url: "/database",
            data: req_items,
            //dataType: "json",
            contentType: "application/json",
            xhrFields: {
                responseType: 'blob' // to avoid binary data being mangled on charset conversion
            },
            success:
                function gotDownload(blob, status, xhr)
                {
                    // check for a filename
                    var filename = "";
                    var disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        var matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                    }

                    if (typeof window.navigator.msSaveBlob !== 'undefined') {
                        // IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
                        window.navigator.msSaveBlob(blob, filename);
                    } else {
                        var URL = window.URL || window.webkitURL;
                        var downloadUrl = URL.createObjectURL(blob);

                        if (filename) {
                            // use HTML5 a[download] attribute to specify filename
                            var a = document.createElement("a");
                            // safari doesn't support this yet
                            if (typeof a.download === 'undefined') {
                                window.location.href = downloadUrl;
                            } else {
                                a.href = downloadUrl;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                            }
                        } else {
                            window.location.href = downloadUrl;
                        }

                        setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup
                    }
                }
            },
        );

    return true;
}
function RequestClearData()
{
    var answer = prompt("Please confirm that you wish to clear (removes from list) all selected data by typing in 'Rufus'", "");

    if (answer != "Rufus") {
        alert("Incorrect answer, not deleting anything");
        return false;
    }
    console.log("Requesting data delete...");
    var req_items = GetChecks();
    ClearAllChecks();
    req_items = JSON.stringify({selitems:req_items});
    $.ajax({
            type: "POST",
            url: "/cleardata",
            data: req_items,
            //dataType: "json",
            contentType: "application/json",
            success: function (data, status, jqXHR) {
                location.reload();
            }
        });

        return true;
}
function RequestResetData()
{
    var answer = prompt("Please confirm that you wish to reset (delete for good) all selected data by typing in 'Rufus'", "");

    if (answer != "Rufus") {
        alert("Incorrect answer, not deleting anything");
        return false;
    }
    console.log("Requesting data delete...");
    var req_items = GetChecks();
    ClearAllChecks();
    req_items = JSON.stringify({selitems:req_items});
    $.ajax({
            type: "POST",
            url: "/resetdata",
            data: req_items,
            //dataType: "json",
            contentType: "application/json",
            success: function (data, status, jqXHR) {
                location.reload();
            }
        });

        return true;
}
</script>
</html>
